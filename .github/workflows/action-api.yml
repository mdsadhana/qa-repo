name: Run pytest on PR

on:
  pull_request:
    branches:
      - main  # Adjust branch name as per your
env:
  ZO_ROOT_USER_EMAIL: "root@example.com"
  ZO_ROOT_USER_PASSWORD: "Complexpass#123"
  ZO_BASE_URL: "http://localhost:5080"

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      # Label used to access the service container
      redis:
        # Docker Hub image
        image: openobserve/openobserve:latest
        #
        ports:
          # Opens tcp port 5080 on the host and service container
          - 5080:5080


    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Rust
      uses: Swatinem/rust-cache@v2

    - name: Start OpenObserve
      run: ./target/release/openobserve

    - name: Set environment variables
      run: |
          echo "export ZO_ROOT_USER_EMAIL=${ZO_ROOT_USER_EMAIL}" >> $GITHUB_ENV
          echo "export ZO_ROOT_USER_PASSWORD=${ZO_ROOT_USER_PASSWORD}" >> $GITHUB_ENV

    - name: Display environment variables
      run: |
          echo "Root User Email: $ZO_ROOT_USER_EMAIL"
          echo "Root User Password: $ZO_ROOT_USER_PASSWORD"

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.11.6  # Specify your Python version

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install pytest
        pip install requests

    - name: Run pytest
      run: |
        pytest tests
